var g=false;
function k(b,d,A){function B(a,c){return a-c}function J(a){return a.reduce(function(c,e){return c+e})/l}function v(){if(!m)if(n==="FastForwardMode"&&(b.ended||j>b.duration))C();else{D.drawImage(b,0,0,p,q,0,0,h,i);var a;a=[];var c=D.getImageData(0,0,h,i).data,e=E.getImageData(0,0,h,i).data,f=c.length;do a.push(Math.sqrt(Math.pow(c[f-4]-e[f-4],2)+Math.pow(c[f+-3]-e[f+-3],2)+Math.pow(c[f+-2]-e[f+-2],2)));while(f-=4);e=J(a);if(r){c=Math.max.apply(null,a);f=Math.min.apply(null,a);a=F(a);a=[e,a,c,f]}else a=
[e];if(a[0]>w){x.sceneTimecodes.push(j);if(r){c=document.createElement("div");e=document.createElement("canvas");f=e.width=p/2;var K=e.height=q/2;e.getContext("2d").drawImage(b,0,0,p,q,0,0,f,K);c.appendChild(document.createTextNode("@ "+j));c.appendChild(document.createElement("br"));c.appendChild(e);c.appendChild(document.createElement("br"));c.appendChild(document.createTextNode("max: "+Math.round(a[2]/o)+"%, avg: "+Math.round(a[0]/o)+"%, med: "+Math.round(a[1]/o)+"%, min: "+Math.round(a[3]/o)+
"%"));s.appendChild(c)}}E.drawImage(t,0,0,h,i,0,0,h,i)}}function C(){A&&A();x.stop()}function L(){if(this.currentTime-y>=u){j=this.currentTime;v();y=this.currentTime}}function G(){v();j+=u;this.currentTime=j}function H(){p=this.videoWidth;q=this.videoHeight;t.width=h;t.height=i;z.width=h;z.height=i;this.removeEventListener("durationchange",H,g)}if(!b||b.constructor.toString().indexOf("HTMLVideoElement")<0)throw"Inputed element is not a video element.";var x=this,n="FastForwardMode",h=50,i=50,u=0.25,
w=25,r=g,o=Math.sqrt(195075)/100,j=0,y=0,p=0,q=0,I=b.controls,t=document.createElement("canvas"),z=document.createElement("canvas"),D=t.getContext("2d"),E=z.getContext("2d"),m=g,l,s,F;(function(){if(d){if(d.mode&&d.mode==="PlaybackMode")n=d.mode;if(d.step_width&&d.step_height){h=parseInt(d.step_width,10);i=parseInt(d.step_height,10)}else if(d.step){h=parseInt(d.step,10);i=parseInt(d.step,10)}if(d.minSceneDuration)u=parseFloat(d.minSceneDuration);if(d.threshold)w=parseFloat(d.threshold);if(d.debug)r=
Boolean(d.debug);y=u}w*=o;l=h*i;if(r){s=document.createElement("div");s.className="scd-debug";document.getElementsByTagName("body")[0].appendChild(s)}b.addEventListener("durationchange",H,g);k.prototype.start=n==="FastForwardMode"?function(){if(!m){b.controls=g;b.currentTime=j;b.addEventListener("seeked",G,g);v()}}:function(){if(!m){b.controls=g;b.currentTime=0;b.addEventListener("timeupdate",L,g);b.addEventListener("ended",C,g);b.play()}};F=l%2?function(a){a.sort(B);return a[(l+1)/2-1]}:function(a){a.sort(B);
var c=(l+1)/2;return(a[c-1.5]+a[c-0.5])/2}})();k.prototype.pause=function(){if(!m){if(n==="FastForwardMode"){b.controls=I;b.removeEventListener("seeked",G,g)}b.pause()}};k.prototype.stop=function(){x.pause();if(n==="FastForwardMode")b.controls=I;m=true}}k.prototype.sceneTimecodes=[];window.Scd=k;
